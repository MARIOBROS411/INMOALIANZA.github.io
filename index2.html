<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Facebook Pixel - ID: 1560096578769877</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #1877F2;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .pixel-id {
            background: #1877F2;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 1.2rem;
            display: inline-block;
            margin: 10px 0;
        }
        
        .debug-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #1877F2;
        }
        
        .debug-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        .debug-label {
            font-weight: bold;
        }
        
        .debug-value {
            font-family: monospace;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            background: #cce7ff;
            color: #004085;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #1877F2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0e5ebe;
        }
        
        .log-container {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            background: white;
            border-left: 4px solid #1877F2;
        }
        
        .solution-box {
            background: #e7f3ff;
            border: 2px solid #1877F2;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Verificador de Facebook Pixel</h1>
            <div class="pixel-id">ID: 1560096578769877</div>
            <p>Diagn√≥stico avanzado del Pixel de Facebook</p>
        </header>

        <div class="debug-panel">
            <h3>üìä Estado del Pixel</h3>
            <div class="debug-item">
                <span class="debug-label">fbq cargado:</span>
                <span class="debug-value" id="fbq-loaded">verificando...</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">fbq.init llamado:</span>
                <span class="debug-value" id="fbq-init">verificando...</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">Estado del Pixel:</span>
                <span class="debug-value" id="pixel-status">verificando...</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">M√©todo de detecci√≥n:</span>
                <span class="debug-value" id="detection-method">verificando...</span>
            </div>
        </div>

        <div class="panel">
            <h3>üéÆ Probar Eventos</h3>
            <button class="btn btn-primary" onclick="testPixel()">Probar Pixel</button>
            <button class="btn btn-primary" onclick="sendTestEvent()">Enviar Evento de Prueba</button>
            <button class="btn btn-primary" onclick="forceReinit()">Reinicializar Pixel</button>
        </div>

        <div class="panel">
            <h3>üìù Registro de Eventos</h3>
            <div class="log-container" id="log">
                <div class="log-entry">Sistema iniciado. Esperando eventos...</div>
            </div>
        </div>

        <div class="solution-box">
            <h3>üö® SOLUCI√ìN SI EL PIXEL NO SE DETECTA</h3>
            <p><strong>Problema:</strong> fbq se carga pero no se inicializa correctamente.</p>
            <p><strong>Soluci√≥n:</strong> </p>
            <ol>
                <li>Haz clic en "Reinicializar Pixel" arriba</li>
                <li>Si no funciona, el problema puede ser:
                    <ul>
                        <li>Bloqueador de anuncios activado</li>
                        <li>Problemas de CORS</li>
                        <li>El dominio no est√° verificado en Facebook</li>
                    </ul>
                </li>
                <li>Prueba en una ventana de inc√≥gnito</li>
            </ol>
        </div>
    </div>

    <!-- C√ìDIGO DEL PIXEL MEJORADO -->
    <script>
        // Guardar referencia global al estado del Pixel
        window.pixelState = {
            loaded: false,
            initialized: false,
            lastEvent: null
        };

        // Funci√≥n para loguear mensajes
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.borderLeftColor = type === 'error' ? '#dc3545' : 
                                         type === 'success' ? '#28a745' : '#1877F2';
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.prepend(entry);
            
            // Limitar a 50 entradas
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
            
            console.log(`[Pixel Debug] ${message}`);
        }

        // Funci√≥n para actualizar la UI del estado
        function updateUI() {
            const fbqLoaded = document.getElementById('fbq-loaded');
            const fbqInit = document.getElementById('fbq-init');
            const pixelStatus = document.getElementById('pixel-status');
            const detectionMethod = document.getElementById('detection-method');

            // Verificar si fbq existe
            if (typeof fbq === 'undefined') {
                fbqLoaded.textContent = '‚ùå NO';
                fbqLoaded.className = 'debug-value error';
                fbqInit.textContent = '‚ùå NO';
                fbqInit.className = 'debug-value error';
                pixelStatus.textContent = '‚ùå PIXEL NO CARGADO';
                pixelStatus.className = 'debug-value error';
                detectionMethod.textContent = 'fbq no definido';
                return;
            }

            fbqLoaded.textContent = '‚úÖ S√ç';
            fbqLoaded.className = 'debug-value success';

            // M√∫ltiples m√©todos para verificar si el Pixel est√° inicializado
            let isInitialized = false;
            let method = '';

            // M√©todo 1: Verificar fbq.loaded
            if (fbq.loaded) {
                isInitialized = true;
                method = 'fbq.loaded = true';
            }

            // M√©todo 2: Verificar mediante getState si est√° disponible
            if (typeof fbq.getState === 'function') {
                try {
                    const state = fbq.getState();
                    if (state && state.pixels && state.pixels['1560096578769877']) {
                        isInitialized = true;
                        method = 'fbq.getState()';
                    }
                } catch (e) {
                    log('Error en fbq.getState(): ' + e.message, 'error');
                }
            }

            // M√©todo 3: Verificar si hay cola de eventos
            if (fbq.queue && fbq.queue.length > 0) {
                isInitialized = true;
                method = 'fbq.queue activa';
            }

            // M√©todo 4: Intentar enviar un evento de prueba
            try {
                // Este es un m√©todo m√°s agresivo pero efectivo
                const originalQueue = fbq.queue ? [...fbq.queue] : [];
                fbq('track', 'TestInitialization', { test: true });
                isInitialized = true;
                method = 'evento de prueba enviado';
                
                // Restaurar la cola original
                if (fbq.queue) {
                    fbq.queue = originalQueue;
                }
            } catch (e) {
                // Si falla, el Pixel probablemente no est√© listo
            }

            if (isInitialized) {
                fbqInit.textContent = '‚úÖ INICIALIZADO';
                fbqInit.className = 'debug-value success';
                pixelStatus.textContent = '‚úÖ PIXEL ACTIVO';
                pixelStatus.className = 'debug-value success';
                window.pixelState.initialized = true;
            } else {
                fbqInit.textContent = 'üîÑ INICIALIZANDO...';
                fbqInit.className = 'debug-value warning';
                pixelStatus.textContent = '‚ö†Ô∏è PIXEL CARGADO PERO NO INICIALIZADO';
                pixelStatus.className = 'debug-value warning';
                window.pixelState.initialized = false;
            }

            detectionMethod.textContent = method || 'm√∫ltiples m√©todos';
            window.pixelState.loaded = true;
        }

        // Funci√≥n para probar el Pixel
        function testPixel() {
            log('=== INICIANDO PRUEBA DEL PIXEL ===');
            
            if (typeof fbq === 'undefined') {
                log('‚ùå fbq NO est√° definido', 'error');
                return;
            }

            log('‚úÖ fbq est√° definido', 'success');
            log(`fbq version: ${fbq.version || 'No disponible'}`);
            log(`fbq.loaded: ${fbq.loaded}`);
            log(`fbq.queue length: ${fbq.queue ? fbq.queue.length : 'No disponible'}`);

            // Intentar m√∫ltiples m√©todos de verificaci√≥n
            if (typeof fbq.getState === 'function') {
                try {
                    const state = fbq.getState();
                    log(`fbq.getState() disponible: ${JSON.stringify(state).substring(0, 200)}...`);
                } catch (e) {
                    log(`‚ùå Error en fbq.getState(): ${e.message}`, 'error');
                }
            }

            updateUI();
        }

        // Funci√≥n para enviar evento de prueba
        function sendTestEvent() {
            if (typeof fbq === 'undefined') {
                log('‚ùå No se puede enviar evento: fbq no est√° definido', 'error');
                return;
            }

            log('üîÑ Enviando evento de prueba...');
            
            try {
                fbq('track', 'TestEvent', {
                    testing: true,
                    timestamp: new Date().toISOString(),
                    source: 'PixelDebugger'
                });
                log('‚úÖ Evento de prueba enviado correctamente', 'success');
                
                // Verificar si el evento se encol√≥
                if (fbq.queue) {
                    log(`Eventos en cola: ${fbq.queue.length}`);
                }
            } catch (error) {
                log(`‚ùå Error enviando evento: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para reinicializar el Pixel
        function forceReinit() {
            log('üîÑ Reinicializando Pixel...');
            
            if (typeof fbq !== 'undefined') {
                try {
                    // Forzar reinicializaci√≥n
                    fbq('init', '1560096578769877', {}, { agent: 'PixelDebugger' });
                    fbq('track', 'PageView');
                    log('‚úÖ Pixel reinicializado manualmente', 'success');
                    
                    // Esperar y volver a verificar
                    setTimeout(updateUI, 1000);
                } catch (error) {
                    log(`‚ùå Error reinicializando: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå fbq no disponible para reinicializaci√≥n', 'error');
            }
        }

        // C√ìDIGO DEL PIXEL DE FACEBOOK
        // Versi√≥n mejorada con manejo de errores
        function loadFacebookPixel() {
            log('üîÑ Cargando Facebook Pixel...');
            
            window.fbq = window.fbq || function() {
                if (window.fbq.queue) {
                    window.fbq.queue.push(arguments);
                } else {
                    console.log('Facebook Pixel queue not ready:', arguments);
                }
            };
            
            if (!window._fbq) window._fbq = window.fbq;
            window.fbq.push = window.fbq;
            window.fbq.loaded = true;
            window.fbq.version = '2.0';
            window.fbq.queue = [];

            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://connect.facebook.net/en_US/fbevents.js';
            
            script.onload = function() {
                log('‚úÖ Script de Facebook Pixel cargado', 'success');
                
                // Esperar un momento y luego inicializar
                setTimeout(function() {
                    try {
                        if (typeof fbq !== 'undefined') {
                            fbq('init', '1560096578769877');
                            fbq('track', 'PageView');
                            log('‚úÖ Pixel inicializado con ID: 1560096578769877', 'success');
                            window.pixelState.initialized = true;
                        }
                    } catch (error) {
                        log(`‚ùå Error inicializando Pixel: ${error.message}`, 'error');
                    }
                    
                    // Actualizar UI despu√©s de la inicializaci√≥n
                    setTimeout(updateUI, 500);
                }, 100);
            };
            
            script.onerror = function() {
                log('‚ùå Error cargando el script de Facebook Pixel', 'error');
            };
            
            document.head.appendChild(script);
        }

        // INICIAR TODO CUANDO LA P√ÅGINA CARGUE
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando verificador de Facebook Pixel...');
            
            // Cargar el Pixel
            loadFacebookPixel();
            
            // Verificar estado peri√≥dicamente
            setInterval(updateUI, 2000);
            
            // Primera verificaci√≥n despu√©s de 1 segundo
            setTimeout(updateUI, 1000);
        });

        // Tambi√©n exponer funciones globalmente para debugging
        window.debugPixel = testPixel;
        window.reinitPixel = forceReinit;
    </script>
</body>
</html>
